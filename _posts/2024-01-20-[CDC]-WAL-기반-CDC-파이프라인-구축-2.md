---
title: "[CDC] WAL 기반 CDC 파이프라인 구축 (2)"
excerpt: "PostgreSQL Wrtie-Ahead LOG 설정 구성"

categories:
  - Data
tags:
  - [Data]

permalink: /data/[CDC]-WAL-기반-CDC-파이프라인-구축-2/

toc: true
toc_sticky: true

date: 2024-01-20
last_modified_at: 2024-01-20
---

# WAL (Write-Ahead Log) 기본 개념
WAL은 데이터베이스가 시스템 충돌이나 장애 후에도 데이터의 일관성을 유지하도록 돕는 로그이다. 
데이터베이스 변경사항(Insert, Update, Delete 등)이 발생하기 전에 이 변경사항을 먼저 로그 파일에 기록하여 
데이터 변경 작업이 반영되기 전에 로그가 먼저 기록되므로 시스템이 예기치 않게 중단되어도 데이터베이스의 상태를 복구할 수 있다.
[wal 관련문서](https://www.postgresql.org/docs/current/wal-intro.html)

## WAL 관련 config 설정
postgesql.conf 파일에서 WAL 관련 설정을 변경할 수 있다.
CDC를 할 때 기본적으로 고려해야하는 조건은 아래와 같다.

wal_level 설정을 logical로 변경
max_wal_senders : 동시에 실행될 수 있는 WAL 스트리밍 연결의 최대 수 설정
max_replication_slots : 데이터베이스에서 사용할 수 있는 복제 슬롯의 최대 수 설정
wal_sender_timeout(옵션) : WAL 스트리밍 연결의 응답이 없을 때 타임아웃 되는 시간 설정 (네트워크 지연 등)

관련 문서 : https://www.postgresql.org/docs/current/runtime-config-wal.html

### WAL 설정 
**기본 설정**
**wal_level** : 로그 수준 설정, 변경 시 서버 재시작 필요  
minimal : 필수적인 정보만 기록하여 성능 최대화  
replica : 복제에 필요한 정보 기록  
logical : 논리적 복제 및 디코딩을 위한 정보 기록  
**fsync** : 데이터를 디스크에 실제로 기록할 것인지 설정, 데이터 안정성을 위해 일반적으로 켜져있음  
**synchronous_commit** : 트랜잭션의 커밋이 완료되기 전에 데이터가 디스크에 기록되는 시점 제어  
**wal_sync_method**: WAL 데이터를 디스크에 동기화하는 방법 설정. 일반적으로 fdatasync가 기본값  
**wal_writer_delay, wal_writer_flush_after**: WAL 라이터 프로세스의 작동 방식 제어  
**wal_buffers**: WAL 버퍼 크기 설정 -1은 시스템이 자동 설정  
**wal_init_zero, wal_recycle**: 새 WAL 파일 생성시 초기화 및 재활용 방식 설정  
**wal_log_hints**: 비관련 업데이트에 대해서도 전체 페이지 쓰기 수행할지 설정  
**wal_compression**: 페이지 전체 쓰기 시 압축 사용할지 여부 결정  
**full_page_writes**: 처음 변경되는 각 데이터 페이지의 전체 내용을 WAL에 기록. 이는 부분적인 페이지 쓰기 오류를 복구하는 데 도움됨

**체크포인트 설정**  
**max_wal_size, min_wal_size** : WAL 파일의 최대 및 최소 크기 설정  
**checkpoint_timeout** : 체크포인트 간의 최대 시간 간격 설정  
**checkpoint_completion_target** : 체크포인트 완료 목표 설정  
**checkpoint_flush_after** : 체크포인트 수행 시 데이터를 디스크에 얼마나 자주 기록할지 설정  

**아카이빙 설정**  
**archive_mode**: WAL 아카이빙을 활성화할지 설정  
**archive_command**: WAL 파일을 아카이브할 때 사용할 명령어 설정  
**archive_timeout**: 아카이브 간 강제 로그 세그먼트 스위치 설정  

**아카이브 복구 설정**  
**restore_command** : 아카이브에서 로그 파일을 복구하는 데 사용할 명령어 설정  
**archive_cleanup_command, recovery_end_command** : 복구 시 사용할 추가 명령어 설정  

```
#------------------------------------------------------------------------------
# WRITE-AHEAD LOG
#------------------------------------------------------------------------------

# - Settings -

wal_level = logical                    # minimal, replica, or logical
                                        # (change requires restart)
#fsync = on                             # flush data to disk for crash safety
                                        # (turning this off can cause
                                        # unrecoverable data corruption)
#synchronous_commit = on                # synchronization level;
                                        # off, local, remote_write, remote_apply, or on
#wal_sync_method = fsync                # the default is the first option
                                        # supported by the operating system:
                                        #   open_datasync
                                        #   fdatasync (default on Linux)
                                        #   fsync
                                        #   fsync_writethrough
                                        #   open_sync
#full_page_writes = on                  # recover from partial page writes
#wal_compression = off                  # enable compression of full-page writes
#wal_log_hints = off                    # also do full page writes of non-critical updates
                                        # (change requires restart)
#wal_init_zero = on                     # zero-fill new WAL files
#wal_recycle = on                       # recycle WAL files
#wal_buffers = -1                       # min 32kB, -1 sets based on shared_buffers
                                        # (change requires restart)
#wal_writer_delay = 200ms               # 1-10000 milliseconds
#wal_writer_flush_after = 1MB           # measured in pages, 0 disables

#commit_delay = 0                       # range 0-100000, in microseconds
#commit_siblings = 5                    # range 1-1000

# - Checkpoints -

#checkpoint_timeout = 5min              # range 30s-1d
max_wal_size = 1GB
min_wal_size = 80MB
#checkpoint_completion_target = 0.5     # checkpoint target duration, 0.0 - 1.0
#checkpoint_flush_after = 256kB         # measured in pages, 0 disables
#checkpoint_warning = 30s               # 0 disables

# - Archiving -

#archive_mode = off             # enables archiving; off, on, or always
                                # (change requires restart)
#archive_command = ''           # command to use to archive a logfile segment
                                # placeholders: %p = path of file to archive
                                #               %f = file name only
                                # e.g. 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'
#archive_timeout = 0            # force a logfile segment switch after this
                                # number of seconds; 0 disables

# - Archive Recovery -

# These are only used in recovery mode.

#restore_command = ''           # command to use to restore an archived logfile segment
                                # placeholders: %p = path of file to restore
                                #               %f = file name only
                                # e.g. 'cp /mnt/server/archivedir/%f %p'
                                # (change requires restart)
#archive_cleanup_command = ''   # command to execute at every restartpoint
#recovery_end_command = ''      # command to execute at completion of recovery

# - Recovery Target -

# Set these only when performing a targeted recovery.

#recovery_target = ''           # 'immediate' to end recovery as soon as a
                                # consistent state is reached
                                # (change requires restart)
#recovery_target_name = ''      # the named restore point to which recovery will proceed
                                # (change requires restart)
#recovery_target_time = ''      # the time stamp up to which recovery will proceed
                                # (change requires restart)
#recovery_target_xid = ''       # the transaction ID up to which recovery will proceed
                                # (change requires restart)
#recovery_target_lsn = ''       # the WAL LSN up to which recovery will proceed
                                # (change requires restart)
#recovery_target_inclusive = on # Specifies whether to stop:
                                # just after the specified recovery target (on)
                                # just before the recovery target (off)
                                # (change requires restart)
#recovery_target_timeline = 'latest'    # 'current', 'latest', or timeline ID
                                # (change requires restart)
#recovery_target_action = 'pause'       # 'pause', 'promote', 'shutdown'
                                # (change requires restart)
```

### Replication 설정
주 서버에서 발송 서버로의 복제 관련 설정  
(각 설정별 내용 추후 보완 예정)  
```
#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------

# - Sending Servers -

# Set these on the master and on any standby that will send replication data.

#max_wal_senders = 10           # max number of walsender processes
                                # (change requires restart)
#wal_keep_segments = 0          # in logfile segments; 0 disables
#wal_sender_timeout = 60s       # in milliseconds; 0 disables

#max_replication_slots = 10     # max number of replication slots
                                # (change requires restart)
#track_commit_timestamp = off   # collect timestamp of transaction commit
                                # (change requires restart)

# - Master Server -

# These settings are ignored on a standby server.

#synchronous_standby_names = '' # standby servers that provide sync rep
                                # method to choose sync standbys, number of sync standbys,
                                # and comma-separated list of application_name
                                # from standby(s); '*' = all
#vacuum_defer_cleanup_age = 0   # number of xacts by which cleanup is delayed

# - Standby Servers -

# These settings are ignored on a master server.

#primary_conninfo = ''                  # connection string to sending server
                                        # (change requires restart)
#primary_slot_name = ''                 # replication slot on sending server
                                        # (change requires restart)
#promote_trigger_file = ''              # file name whose presence ends recovery
#hot_standby = on                       # "off" disallows queries during recovery
                                        # (change requires restart)
#max_standby_archive_delay = 30s        # max delay before canceling queries
                                        # when reading WAL from archive;
                                        # -1 allows indefinite delay
#max_standby_streaming_delay = 30s      # max delay before canceling queries
                                        # when reading streaming WAL;
                                        # -1 allows indefinite delay
#wal_receiver_status_interval = 10s     # send replies at least this often
                                        # 0 disables
#hot_standby_feedback = off             # send info from standby to prevent
                                        # query conflicts
#wal_receiver_timeout = 60s             # time that receiver waits for
                                        # communication from master
                                        # in milliseconds; 0 disables
#wal_retrieve_retry_interval = 5s       # time to wait before retrying to
                                        # retrieve WAL after a failed attempt
#recovery_min_apply_delay = 0           # minimum delay for applying changes during recovery

# - Subscribers -

# These settings are ignored on a publisher.

#max_logical_replication_workers = 4    # taken from max_worker_processes
                                        # (change requires restart)
#max_sync_workers_per_subscription = 2  # taken from max_logical_replication_workers
```

**WAL 파일 읽기**  
PostgreSQL의 pg_wal 디렉토리 안에 있는 WAL 파일들은 바이너리 형식으로 저장되어 있기 때문에 일반적인 텍스트 에디터로 읽을 수 없다.
WAL 파일의 로그를 사람이 읽을 수 있도록 렌더링 도구가 있는데 그게 PostgreSQL에서 제공하는 pg_waldump이다.
다만 pg_waldump를 사용할때는 데이터베이스 서버의 성능에 영향을 줄 수 있으므로 운영 환경에서는 주의하여 사용해야한다.
[pgwaldump 관련 문서](https://www.postgresql.org/docs/current/pgwaldump.html)

1. pg_waldump 사용시 아래와 같이 명령어를 입력한다.  
```
pg_waldump /var/lib/postgresql/data/pg_wal/000000010000000000000001
```

2. 로그 출력  
pg_waldump는 WAL 파일 내의 각 로그 레코드에 대한 정보를 출력한다. 이 정보에는 트랜잭션 ID, LSN(Low Sequence Number), 로그 레코드의 종류, 내용 등이 포함된다.  

WAL을 직접 해석하여 트랜잭션을 처리하는 것은 복잡하기 때문에 Debezium과 같은 오픈 소스 CDC 플랫폼을 사용한다.
Debezium CDC 커넥터를 사용하면 WAL을 모니터링하여 데이터베이스에서 발생하는 모든 변경 사항을 감지하고 해당 변경 사항을 카프카 토픽으로 전송한다.
또한 전송된 변경사항을 싱크 커넥터로 연결하여 타겟 데이터베이스에 데이터를 적재하도록 할 수 있다.


