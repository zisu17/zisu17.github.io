---  
title: "[Kafka] 카프카 데이터 처리 병문 문제해결"  
excerpt: "스파크 스트리밍 어플리케이션의 파티션 기반 구독 방식 적용 사례"  
  
categories:  
  - Data  
tags:  
  - [Data]  
permalink: /data/[Kafka]-카프카-데이터-처리-병목-문제해결/  
  
toc: true  
toc_sticky: true  
  
date: 2024-05-24  
last_modified_at: 2024-05-24  
---  
  
### 이슈 해결 방안  
**이슈 내용**  
![img.png](/assets/images/2024-05-24-[Kafka]-카프카-데이터-처리-병목-문제해결/Pasted image 20240809171802.png)
![img.png](/assets/images/2024-05-24-[Kafka]-카프카-데이터-처리-병목-문제해결/Pasted image 20240809173222.png)
  
- 스크래핑 데이터 수집 할 때 감성 분석 처리가 데이터를 수집하는 속도를 따라가지 못해 적재가 밀리는 현상이 발생함  
  
**해결 내용**  
- 해당 데이터를 구독하는 스파크 스트리밍 어플리케이션을 추가로 생성하여 하나의 토픽을 여러개의 어플리케이션이 처리하도록 수정  
- 카프카 토픽의 구독 방식 변경    
`.option("subscribe", 'landing_blog_cafe')` : 하나의 스파크 스트리밍 어플리케이션이 해당 카프카 토픽에 있는 모든 파티션을 구독    
`.option("assign", '{"landing_blog_cafe":[0, 1]}'`) : 해당 카프카 토픽에 있는 특정 파티션을 구독  
- 변경시 기존 offset을 사용하지 않고 처음부터 다시 컨슈밍하게 되므로 해당 부분 주의 필요  
- assign 옵션으로 2개의 스파크 어플리케이션이 파티션을 분리하여 컨슈밍할 수 있도록 수정 완료  
  
```  
df_before = spark \    
    .readStream \    
    .format("kafka") \    
    .option("kafka.bootstrap.servers", kafka_bootstrap_servers) \    
    .option("maxOffsetsPerTrigger", 100) \    
    .option("startingOffsets", "latest") \    
    .option("failOnDataLoss", "false") \    
    .option("subscribe", "topic_name") \    
    .option("kafka.group.id", "group_a") \    
    .load()  
```  
  
```  
df_after = spark \    
    .readStream \    
    .format("kafka") \    
    .option("kafka.bootstrap.servers", kafka_bootstrap_servers) \    
    .option("maxOffsetsPerTrigger", 100) \    
    .option("startingOffsets", "latest") \    
    .option("failOnDataLoss", "false") \    
    .option("assign", "{'topic_name': [2, 3]}") \    
    .load()  
```  
  
### 처음 시도한 방식  
  
- 2개의 스파크 어플리케이션에서 동일한 그룹 아이디를 사용하려고 했으나 오류 발생  
- 서로 다른 그룹 아이디를 할당했을때는 중복 컨슈밍 문제 발생  
- 기존 카프카 토픽의 파티션을 4개로 줄이고 각 스파크 애플리케이션에 0,1 / 2,3 파티션 번호를 할당했으나 이전에 5개 파티션일 때 존재했던 4번 파티션을 읽으려고 시도하다가 오류가 발생함    
→ 기존에 사용하던 체크포인트를 그대로 사용하여 문제 발생한 것으로 추정checkpointLocation 폴더 삭제후 재가동하니 정상 작동 확인 완료  
  
```  
org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before the position for partition landing_blog_cafe - 4 could be determined  
```